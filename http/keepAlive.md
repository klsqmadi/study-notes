### connection
- http1.0默认是每次请求/应答，客户端和服务器都要新建一个连接，完成请求之后就断开连接
- http1.1默认保持了长连接，数据传输完成，保持tcp的连接不断开，等待同域名下继续使用这个通道

#### keep-alive建立过程
- 客户端向服务器发送请求时在首部添加connection字段
- 服务器收到并处理connection字段
- 服务器回送connection：keep-alive字段给客户端
- 客户端收到connection字段，保持连接
- keep-alive建立成功

#### 服务器自动断开过程
- 客户端向服务器发送请求没有携带connection字段
- 服务器收到并处理
- 服务器回送数据并关闭连接
- 客户端发现没有connection字段，关闭连接
### 导致问题
#### 长时间不通讯，如何确保这个tcp连接是否健康
- tcp的保活机制keep-
- 再一段时间（7200秒）内，此连接都不活跃，开启保活功能的侦测功能，在每70秒发送一个侦测报文，最多发送9次，即共计：2小时11分钟15秒后会自动断开TCP连接。如果服务器对侦测报文做出响应，就重置保活时间计时器

#### 如何知道在长连接中一次数据传输是否完成
- 使用首部content-length，表示实体内容长度，当服务器可以清楚知道数据内容大小的时候就可以使用这个，例如静态图片和页面
- 对于动态数据，例如从数据库中查询生成一个大的html表格，可以使用Transfer-Encoding：chunked，即分块传输，长度 + \r\n + 数据 + \r\n ，他有一个结束块0\r\n \r\n
#### 优点
- 减少了cpu和内存的使用，因为同时打开的连接少了
- tcp连接减少，减低延迟
#### 缺点 
- 线头阻塞，下一次的请求必须等到上次响应返回后才能发起，如果上次的请求还未返回结果，下次请求只能等着