#### DNS


- domain name system
- 全球范围的域名和ip地址相互映射的一个分布式数据库
- DNS协议使用UDP和TCP,UDP通常用于查询和响应,TCP用于主服务器和从服务器之间的传送，因为UDP最大传送长度是512字节，要让所有的根服务器数据能包含在一个UDP包里,IPCV4服务器最多13个，A-M，而真正工作运行肯定不止13台服务器，而是包含很多服务器镜像的

#### DNS缓存

- 浏览器缓存：一次请求首先会通过浏览器缓存信息去寻找域名映射的ip地址
- 操作系统：通过hosts文件来映射域名和ip
- local DNS：本地域名系统LDNS，LDNS一般都缓存了大部分的域名解析的结果，如果TTL未过期，即返回结果，如果过期就需要像权威DNS获取结果
- 根域名服务器：用于解析顶级域名
#### 过程
- 在浏览器输入url之后，会将域名解析成ip地址，会通过dns域名解析
- 首先在浏览器的缓存信息去寻找域名映射的ip地址，如果没有则
- 在操作系统的hosts文件去寻找域名映射的ip地址，如果没有则
- 在路由器的缓存信息去寻找记录，如果没有则
- 去local DNS寻找，如果找到并且TTL没有过期就返回结果，如果过期或者没有就需要向根域名服务器发送DNS解析请求
- local DNS接收到请求，首先从root hints根提示（root hints包含了互联网根域名服务器的地址信息）去找到根域名服务器的ip地址，然后向根域名服务器发送DNS域名解析请求，根域名服务器根据接收到的url顶级域名返回对应的顶级域名如.com .cn 的服务器地址
- local DNS获取到顶级域名服务器ip地址就会向该ip地址发送dns域名解析请求，顶级域名根据接收到的url，返回对应的baidu.com的二级域名服务器地址
- local DNS向baidu.com二级域名发送解析请求，最终获取www.baidu.com对应的ip地址信息
- local DNS将递归查询到的ip地址缓存并返回给客户端
- 如果二级域名返回的是对应的CNAME记录，而不是ip地址或者A记录，就需要多进行一次DNS解析
##### CNAME的存在意义
- A记录是将一个域名解析到一个ip地址，而CANAME是把一个域名解析到另外一个域名，这个别名也要做一个A记录解析到ip地址，使用CNAME可以很方便的更改ip地址，如果一个服务器由100个网站，他们都做了别名，那么服务器变更ip地址时，只需要将别名的A记录变更以下即可
- CNAME存在的主要意义是，有的域名不属于你自己的，在你使用CDN时，服务商给你提供的就是一个CNAME地址，如果服务商给你提供一个ip地址，如果服务商想要更换服务器ip时，可以直接更换，如果使用A记录，那么所有人都要更改对应的ip地址。
- CDN之所以使用CNAME，最主要原因是要根据用户所在位置选择最优节点ip，如果不用cname，A记录直接解析返回ip，那么就无法实现cdn的加速效果
- 使用CNAME唯一的坏处就是解析DNS的时候要多解析一次
#### 域名解析记录
- A记录，用于指定域名对应的ip，A记录可以将多个域名指定到同一个ip，但是不能将一个域名指定到多个ip
- CNAME记录，别名解析，将一个域名指定到另外一个域名，
- MIX记录，将某个域名下的邮件服务器直线到自己的邮件服务器
- NS记录,为某个域名指定DNS解析服务器
- TXT记录，为某个主机域名设置一个说明
#### DNS解析
#### 主机是怎么知道local DNS服务器的
- 通过DHCP协议获取，或者通过手动配置

- ![preview](https://segmentfault.com/img/remote/1460000023342302/view)

##### DNS劫持

- DNS劫持就是通过劫持了DNS服务器，通过某些手段取得某域名的解析记录控制权，进而修改此域名的解析结果，导致对该域名的访问由原IP地址转入到修改后的指定IP，其结果就是对特定的网址不能访问或访问的是假网址，从而实现窃取资料或者破坏原有正常服务的目的。DNS劫持通过篡改DNS服务器上的数据返回给用户一个错误的查询结果来实现的。

##### DNS污染

- DNS污染是一种让一般用户由于得到虚假目标主机IP而不能与其通信的方法，是一种DNS缓存投毒攻击（DNS cache poisoning）。其工作方式是：由于通常的DNS查询没有任何认证机制，而且DNS查询通常基于的UDP是无连接不可靠的协议，因此DNS的查询非常容易被篡改，通过对UDP端口53上的DNS查询进行入侵检测，一经发现与关键词相匹配的请求则立即伪装成目标域名的解析服务器（NS，Name Server）给查询者返回虚假结果。

  　　而DNS污染则是发生在用户请求的第一步上，直接从协议上对用户的DNS请求进行干扰。

- [DNS](https://link.segmentfault.com/?url=http%3A%2F%2Fwww.cloudxns.net)劫持就是指用户访问一个被标记的地址时，DNS服务器故意将此地址指向一个错误的IP地址的行为。范例，网通、电信、铁通的某些用户有时候会发现自己打算访问一个地址，却被转向了各种推送广告等网站，这就是DNS劫持。

  　　DNS污染，指的是用户访问一个地址，国内的服务器(非DNS)监控到用户访问的已经被标记地址时，服务器伪装成DNS服务器向用户发回错误的地址的行为。范例，访问Youtube、Facebook之类网站等出现的状况。
##### 解决方法
- 使用https DNS，就是不走运营商本地DNS
- 使用可靠递归解析器，因为在不同的网络可能使用的解析器不一样，有可能有一些是不可信的，会跟踪你访问的访问，可靠递归解析器就是公举一个可靠的DNS服务商，所有DNS请求发往那里
#### CDN

- 作用：在现有的internet中增加一层新的cache缓存层,将网站的内容分布到最接近用户的网络边缘的节点,使用户可以就近取得所需的内容,提高用户访问网站的响应速度,从技术上全面解决由于网络带宽小,用户访问量 大,网点分布不均匀

##### 流程

- 1.在域名授权dns查询域名记录返回指定域名的Cname记录,对cname进行再解析,得到cdn全局负载均衡缓存服务器地址,
- 2.向全局负载均衡缓存服务器请求，通过智能调度cdn,根据用户local dns 选择一台用户所属的区域负载均衡服务器,根据用户ip地址判断哪一台服务器离用户最近，请求的url判断哪一台服务器有内容，查询当前各个服务器的负载情况，返回一台缓存服务器的ip给用户,用户向这个ip地址发起请求

### 浏览器缓存

#### 客户端缓存

- 客户端缓存分为http缓存和本地存储

#### http缓存

- 本地缓存
  - memory cache(内存缓存)
    - webkit资源分为主资源和派生资源
    - 主资源：HTML页面或下载项
    - 派生资源：HTML页面中内嵌的图片或脚本（一般脚本、字体、图片会存在内存当中）
  - disk cache（硬盘缓存）
- 三级缓存原理
  - 1.先在内存中查找，如果有，直接加载
  - 2.如果内存中不存在，则在硬盘中查找，如果有直接加载
  - 如果硬盘也没有，那么就进行网络请求
  - 请求获取的资源缓存到硬盘和内存中
- 浏览器再向服务器请求资源时,首先判断是否命中强缓存,再判断是否命中协商缓存!

- 强缓存
  - 浏览器在加载资源时，会先根据本地缓存资源的 header 中的信息判断是否命中强缓存，如果命中则直接使用缓存中的资源不会再向服务器发送请求。
  - expires (http1.0) ：一个日期，时间戳，在判断是否过期时是根据本地时间来判断的，如果本地与服务器时间不同步，会造成麻烦
  - cache-control (http1.1)
    - public 表示可以被任何对象进行缓存，发送请求的客户端，代理服务器等
    - private 表明只能被单个用户缓存，例如代理服务器这类共享缓存就不行
    - max-age：资源有效期 ，相对于请求的时间
    - no-cache：表明在使用该缓存之前要向服务器发送请求进行验证，协商缓存
    - no-store：禁止使用缓存
- 协商缓存
  - 跟服务器协商一下，发请求确认是否更新，304则从本地缓存中读取数据
  - 第一次请求返回的response header 携带 Last-modified / 在协商缓存进行第二次请求的时候 request header  携带 If-Modified-Since，这个字段的值是第一次请求response header last-modified的值
  - last modified是秒级别更新，有时候不能准确的描述资源的变化，所以E-tag是根据资源内容生成的唯一标识，这个标识与内容相关，可以准确描述内容的变化
  - Etag / If-None-Match`12
